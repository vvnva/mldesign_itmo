# ML System Design: Классификация обращений OTRS

## 1. Зачем идём в разработку продукта

- **Проблема AS IS**:
  - Оператор вручную читает обращения и выставляет атрибуты (`Тип`, `Общая тема`, `Тематика`, № АЗС и другие атрибуты)
  - Фактический срок первичной маршрутизации: **> 5 дней** при целевом регламенте **1 день для 99% обращений**
  - Высокая нагрузка операторов

- **Цель продукта**:
  - Сократить срок первичной маршрутизации до **1 дня** за счёт автоматизации
  - Снизить нагрузку на операторов и долю рутинной ручной классификации
  - Обеспечить качество маршрутизации, сопоставимое или лучше ручной обработки

## 2. Бизнес-требования и ограничения

### 2.1. Основные требования

- Автоматическая классификация обращений:
  - **Тип**
  - **Общая тема**
  - **Тематика**
- Побочно — извлечение сущностей:
  - номер АЗС;
  - номер карты лояльности (по диапазонам и маскам)
  - иные структурированные поля при необходимости

### 2.2. Качество

- Ошибка классификации по типу/тематике не должна приводить к массовой неверной маршрутизации.
- Приоритет — высокая точность (`Precision`) по классам

По тестовой выборке считаются следующие метрики:
- (`Precisoin`, `Recall`) по отдельным классам
- взвешенный f1 по числу семплов в классах
- средняя взвешенная f-мера с коэффициентом бета от 0.5 до 1 с шагом 0.05:
    - считаем f с бета=0.5 для всех классов, считаем взвешенный f бета
    - считаем f с бета=0.55 для всех классов, считаем взвешенный f бета
    - и так далее до бета=1, после чего считаем среднюю f-меру

- Требования к метрикам (для MVP):
  - средняя f-мера > 0.65

Для NER:
- стандартные метрики:
  - entity-level Precision, Recall, F1 по типам сущностей (АЗС, карты и др.)

### 2.3. Технические ограничения

- Источник данных: выгрузки из OTRS в формате `xlsx`
- На этапе MVP — **офлайн-режим**:
  - вход: файл `xlsx` с обращениями;
  - выход: файл `xlsx` с заполненными полями.
- Далее возможно внедрение в инфраструктуру, поэтому:
  - требуется оценка ресурсопотребления модели (GPU, RAM, время инференса на N обращений)

## 3. Скоуп итерации (MVP)

### 3.1. Входит в скоуп

- Анализ выгрузки за 6 месяцев, выделение паттернов оформления обращений
- Выделение целевого текста обращения:
  - эвристики и регулярные выражения для структурированных паттернов
  - базовая сегментация текста для неструктурированных писем
- Подготовка датасета для обучения:
  - фильтрация обращений без целевого текста;
  - использование только закрытых тикетов с заполненными `Тип`, `Тема`, `Тематика`
- Обучение и оценка моделей для:
  - классификации `(Тип, Тема, Тематика)`;
  - побочной задачи NER (номера АЗС, номера карт лояльности и др)
- Реализация офлайн-пайплайна:
  - чтение `xlsx` → предобработка → инференс → выгрузка `xlsx`.
- Оценка потребляемых ресурсов моделей

### 3.2. Не входит в скоуп

- Интеграция в продуктивный контур (онлайн-инференс)
- Разработка полноценного UI для операторов
- Глубокая оптимизация под редкие тематики с малым числом примеров

## 4. Предпосылки решения

- Исторические данные доступны в виде выгрузки из OTRS за 6 месяцев:
  - для части обращений легко выделяемые паттерны
  - для половины обращений — неструктурированный текст
- Значительная доля обращений приходится на типичные сценарии:
  - «Удаление аккаунта» (около четверти всех обращений)
  - частые тематики по Программе лояльности и Мобильному приложению
- Наблюдаются шумы:
  - технические заголовки (откуда отправлено, подписи, служебная информация)
  - чисто корпоративные переписки без целевого текста

Эти предпосылки позволяют:
- использовать паттерны и регулярные выражения для выделения целевого текста и сущностей
- применить ML-модели для семантической классификации по «очищенному» тексту

## 5. Постановка задачи

### 5.1. Формальная постановка

- **Дано**:
  - сырой текст обращения `X` с большим количеством шума
  - дополнительные признаки (источник обращения `Способ поступления`, признаки, извлечённые NER)
- **Надо предсказать**:
  - `y_type` - (Тип)
  - `y_topic` (Общая тема)
  - `y_subtopic` (Тематика)

Дополнительная задача:
- по тому же `X` извлечь сущности:
  - `station_id` (№ АЗС)
  - `card_number`

### 5.2. Тип задач

- Многоклассовая текстовая классификация (несколько связанных задач)
- Распознавание сущностей (NER)

## 6. Блок-схема решения (описание)
Загрузка данных → Определение паттерна → Выделение текста → NER → Классификация → Формирование результата → Оценка ресурсов

Логика системы в терминах шагов пайплайна:

1. **Загрузка данных**
   - Получение выгрузки `xlsx` из OTRS
   - Фильтрация по:
     - статусу «Закрыто»;
     - наличию заполненных целевых полей `Тип`, `Тема`, `Тематика` (для обучения).

2. **Идентификация паттерна обращения**
   - Для каждого обращения определяется паттерн
   - Используются регулярные выражения, шаблоны тем/заголовков

3. **Выделение целевого текста**
   - Для структурированных паттернов:
     - применение эвристик (регулярные выражения, разметка блока «Сообщение» и тп)
   - Для неструктурированных:
     - сегментация текста с удалением технических строк (подписей, цитируемой переписки, хедеров)
     - при отсутствии целевого текста обращение может исключаться из обучающей выборки

4. **Выделение сущностей (NER)**
   - По очищенному тексту:
     - извлечение номеров карт по маскам и диапазонам;
     - извлечение номеров АЗС
   - Результаты могут использоваться:
     - как отдельный выход системы (для маршрутизации)
     - как признаки для классификатора

5. **Модуль классификации**
   - Вход: целевой текст + признаки NER
   - Модели:
     - классификатор `Тип`
     - классификатор `Тема`
     - классификатор `Тематика` (возможна иерархическая схема: сначала `Тема`, затем `Тематика`)
   - Выход: предсказанные значения `Тип`, `Тема`, `Тематика` + вероятности/скор

6. **Формирование результата**
   - Формирование выходного `xlsx`:
     - `Суть обращения`
     - `Способ поступления`;
     - предсказанные `Тип`, `Общая тема`, `Тематика`;
     - № АЗС, № карты

7. **Оценка ресурсов**
   - Замер:
     - времени инференса на N обращений
     - потребления памяти
     - загрузки GPU
   - Подготовка оценки для возможного развёртывания на стороне заказчика


## 7. Риски и открытые вопросы

- **Шум и отсутствие целевого текста**:
  - часть обращений не содержит содержательной части (только техническая информация или цепочки переписок)
  - требуется уточнение, можно ли такие обращения системно отбрасывать при формировании выборки.

- **Цепочки пересланных сообщений**:
  - вопрос: как операторы работают с цепочками и как именно проставляются `Тип`, `Тема`, `Тематика` для писем без нового текста

- **Редкие темы и тематики**:
  - малое число примеров может привести к низкой устойчивости классификации
